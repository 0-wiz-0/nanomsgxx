<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="nanomsgxx : nanomsg binding for C++11" />
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">
    <title>nanomsgxx</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a href="index.html">
          <h5 id="project_title" class="nnxx-title">nanomsgxx</h5></a>
          <a id="forkme_banner" href="https://github.com/achille-roussel/nanomsgxx">View on GitHub</a>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">

<div class="navigation">
  <span class="left"><a href="index.html">&laquo; Intro</a></span>
  <span class="right"><a href="messages.html">Messages &raquo;</a></span>
</div>

<h1>
<a name="design" class="anchor" href="#design"><span class="octicon octicon-link"></span></a>Design</h1>

<p>
This chapter exposes the main design decisions that were made when developping
nanomsgxx, it covers these topics:
</p>
<ul>
<li><a href="#constants"><strong>Constants</strong></a></li>
<li><a href="#strings"><strong>Strings</strong></a></li>
<li><a href="#objects"><strong>Objects</strong></a></li>
<li><a href="#exceptions"><strong>Exceptions</strong></a></li>
</ul>

<h2>
<a name="constants" class="anchor" href="#constants"><span class="octicon octicon-link"></span></a>Constants</h2>
<p>
nanomsg uses many constants to represent protocols, socket domains, options, flags...
Since C++ syntax is mostly compatible with C, standard nanomsg constants (NN_*) can be
simply used wherever constants are expected in the C++ API.<br/>
However nanomsgxx ports all constants within the <strong>nnxx</strong> namespace,
removing the leading <strong>NN_</strong>. For example the <strong>NN_MSG</strong>
constant in the C API is ported by the <strong>nnxx::MSG</strong> symbol.
This applies to almost all constants, except in a few cases where it conflicts with
some existing symbols (more on that later).
</p>

<h2>
<a name="strings" class="anchor" href="#strings"><span class="octicon octicon-link"></span></a>Strings</h2>
<p>
nanomsgxx functions accept string arguments in some cases, to bind or connect to a
node for example. Everywhere a string is expected the functions are designed to
receive any object that can be converted to a C-string (null-terminted <strong>char</strong>
sequence), this includes:
</p>
<ul>
<li>objects of <strong>const char *</strong> type, or implicitly converted to this pointer type</li>
<li>objects of <strong>std::string</strong> type, or any other specialization of
<a href="http://en.cppreference.com/w/cpp/string/basic_string">std::basic_string</a>
<li>any object that has a <strong>c_str</strong> member function returning a <strong>const char *</strong>
</ul>
<p>
This feature can be extended by providing a <strong>c_str</strong> function for new types,
for example:
</p>
<div class="highlight highlight-c++">
<pre><span class="k">namespace</span> X {
  <span class="k">const </span><span class="kt">char </span>*c_str(<span class="k">const </span><span class="kt">other_string_type </span>&amp;s) {
    <span class="k">return </span>s.c_string();
  }
}
</pre>
</div>

<h2>
<a name="objects" class="anchor" href="#objects"><span class="octicon octicon-link"></span></a>Objects</h2>
<p>
The nanomsgxx API provides a few object types that abstracts concepts of the C
API, while trying to stay as close as possible it adds a few extra types to
integrate with the C++ standard library and take advantages of the rich features
of the language.
</p>
<strong>Moveable Objects</strong>
<p>
All types in the nanomsgxx API provide a <a href="http://en.cppreference.com/w/cpp/language/move_operator">
move constructor</a> and a <a href="http://en.cppreference.com/w/cpp/language/move_operator">move assignment
operator</a>, these are powerful features of C++11 and the library makes heavy use of it to provide an easy
resource management model, as well as protecting the user from mis-using the library in some places.
</p>
<strong>Member vs Non-Member Functions</strong>
<p>
Member functions are used of nanomsgxx objects to provide operations that are
part of the object's identity, providing the low-level pieces on which extensions
can be built.<br/>
For example the <strong>nnxx::socket</strong> type will have the <strong>recv</strong>
and <strong>send</strong> member functions because receiving and sending messages
are the core features of the this type, but protocol extensions such as turning on
or off Nagle's algorithm for TCP connections will be provided as a non-member
function because it's not an operation that can be performed on any socket type.
</p>

<h2>
<a name="exceptions" class="anchor" href="#exceptions"><span class="octicon octicon-link"></span></a>Exceptions</h2>
<p>
The nanomsg library uses the POSIX mechanism to report errors, setting errno
to some error number and returning a nagative number from the function.
C++ exceptions are used to report these conditions and almost all exceptions
thrown by the nanomsgxx functions are sub-classes of
<a href="http://en.cppreference.com/w/cpp/error/system_error">std::system_error</a>,
so the original error number that was generated by the underlying nanomsg routine
can be accessed through the caught exception.
</p>
<strong>Signals</strong>
<p>
When a program receives a signal it may cause any ongoing system call to be
cancelled to execute a signal handler instead, in that case the systeam call
terminates with the <strong>EINTR</strong> error code.
While nanomsg mirrors this behavior, nanomsgxx reports these conditions with
the <strong>nnxx::signal_error</strong> exception.<br/>
This can be deactivated on a per-call basis by passing <strong>nnxx::NO_SIGNAL_ERROR</strong>
in the flags argument on any blocking call, you should then refer to the documentation
of each function to understand how to handle this case.
</p>
<strong>Timeouts</strong>
<p>
nanomsg's API lets the user define a timeout for any blocking operation (typically
receiving or sending messages), and reports any timeout in the operation with
a <strong>nnxx::timeout_error</strong> exception.<br/>
This can be deactivated on a per-call basis by passing <strong>nnxx::NO_TIMEOUT_ERROR</strong>
in the flags argument on any blocking call, you should then refer to the documentation
of each function to understand how to handle this case.
</p>
<strong>Termination</strong>
<p>
When the program is about to exit it is supposed to inform the nanomsg library
by calling <a href="http://nanomsg.org/v0.3/nn_term.3.html">nn_term</a>, making
any future or pending calls to nanomsg routines failing and setting <em>errno</em>
to <strong>ETERM</strong>. While this is still reported with an exception in nanomsgxx
it's on case where the exception thrown isn't a sub-class of <strong>std::system_error</strong>.
The <strong>nnxx::term_error</strong> exception is instead a sub-class of
<a href="http://en.cppreference.com/w/cpp/error/logic_error">std::logic_error</a>.
That allows the program to handle this condition away from local error handling logic.
</p>
<strong>Memory Allocation</strong>
<p>
The nanomsg library uses dynamic memory allocations in some places, if these fail
for whatever reasons the functions report the error with the <strong>ENOMEM</strong>
<em>errno</em> code.<br/>
This is another case where nanomsgxx will report an error through an exception that
is not a subclass of <strong>std::system_error</strong>.<br/>
The C++ standard library
provides the
<a href="http://en.cppreference.com/w/cpp/memory/new/bad_alloc">std::bad_alloc</a>
exception for this purpose, in order to easily integrate with programs that are
written for standard C++ nanomsgxx also reports memory allocation failures by
throwing an instance of <strong>std::bad_alloc</strong>.
</p>

<div class="navigation">
  <span class="left"><a href="index.html">&laquo; Intro</a></span>
  <span class="right"><a href="messages.html">Messages &raquo;</a></span>
</div>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">nanomsgxx maintained by <a href="https://github.com/achille-roussel">achille-roussel</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

  </body>
</html>
